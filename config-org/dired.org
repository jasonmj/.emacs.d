#+TITLE: Dired
#+PROPERTY: header-args      :tangle "../config-elisp/dired.el"
* Dired Base Config
#+BEGIN_SRC emacs-lisp
(setq dired-listing-switches "-l -A -h -v --group-directories-first")
(defun dired-navigation-keys ()
  (define-key dired-mode-map "[" (lambda nil (interactive) (dired-single-buffer
"..")))
  (define-key dired-mode-map "]" 'dired-single-buffer))
(add-hook 'dired-mode-hook #'dired-navigation-keys)
(global-set-key (kbd "C-x d") 'dired-x-find-file)
(global-set-key (kbd "C-x C-d") 'dired-x-find-file)
(key-seq-define-global "xd" 'dired-x-find-file)
#+END_SRC
* Dired All the Icons Mode
#+BEGIN_SRC emacs-lisp
(use-package all-the-icons-dired
  :ensure t
  :config
  (defun all-the-icons-dired--refresh ()
    "Display the icons of files in a dired buffer."
    (all-the-icons-dired--remove-all-overlays)
    (unless (file-remote-p default-directory)
      (save-excursion
        (goto-char (point-min))
        (while (not (eobp))
          (when (dired-move-to-filename nil)
            (let ((file (dired-get-filename 'relative 'noerror)))
              (when file
                (let ((icon (if (file-directory-p file)
                                (all-the-icons-icon-for-dir file
                                                            :face 'all-the-icons-dired-dir-face
                                                            :v-adjust all-the-icons-dired-v-adjust)
                              (all-the-icons-icon-for-file file :v-adjust all-the-icons-dired-v-adjust))))
                  (if (member file '("." ".."))
                      (all-the-icons-dired--add-overlay (point) "  \t")
                    (all-the-icons-dired--add-overlay (point) (concat icon "\t")))))))
          (forward-line 1)))))
  :hook
  (dired-mode . all-the-icons-dired-mode))
#+END_SRC
* Dired Recent Directories
#+begin_src emacs-lisp
(defun dired-recent-dirs ()
  "Present a list of recently used directories and open the selected one in dired"
  (interactive)
  (let ((recent-dirs
         (delete-dups
          (mapcar (lambda (file)
                    (if (file-directory-p file) file (file-name-directory file)))
                  recentf-list))))

    (let ((dir (completing-read "Recent directory: " recent-dirs)))
      (dired dir))))
(exwm-input-set-key (kbd "C-x d") 'dired-recent-dirs)
#+end_src
* Direnv
#+BEGIN_SRC emacs-lisp
(use-package direnv :ensure t :hook (after-init . direnv-mode))
#+END_SRC
* Dotfile Visibility
#+BEGIN_SRC emacs-lisp
(use-package dired-hide-dotfiles :ensure t)
(defun dired-toggle-dotfiles()
  (dired-hide-dotfiles-mode)
  (revert-buffer)
  (define-key dired-mode-map "." 'dired-hide-dotfiles-mode))
(add-hook 'dired-mode-hook #'dired-toggle-dotfiles)
(require 'dired-x)
(setq-default dired-omit-files-p t) ; Buffer-local variable
(setq dired-omit-files (concat dired-omit-files "^\\.?#\\|^\\.$\\|^\\.\\.$"))
#+END_SRC
* Enable Tabbed Subtree Navigation
#+BEGIN_SRC emacs-lisp
(use-package dired-subtree
  :ensure t
  :after dired
  :config
  (bind-key "<tab>" (lambda()(interactive)(dired-subtree-toggle)(revert-buffer)) dired-mode-map)
  (bind-key "<backtab>" #'dired-subtree-cycle dired-mode-map))
#+END_SRC
* Handle Zip Files
#+BEGIN_SRC emacs-lisp
(eval-after-load "dired-aux"
  '(add-to-list 'dired-compress-file-suffixes
                '("\\.zip\\'" ".zip" "unzip")))
#+END_SRC
* Hide Details
#+BEGIN_SRC emacs-lisp
(defun hide-details-mode-hook ()
  (dired-hide-details-mode))
(add-hook 'dired-mode-hook #'hide-details-mode-hook)
#+END_SRC
* Open With Settings
#+BEGIN_SRC emacs-lisp
(use-package openwith
  :ensure t
  :config
  (setq openwith-associations '(
                              ("\\.desktop\\'" "dex" (file))
                              ("\\.csv\\'" "libreoffice" (file))
                              ("\\.xlsx\\'" "libreoffice" (file)))))
(add-hook 'dired-mode-hook 'openwith-mode)
#+END_SRC
* Reload dired after making changes
#+BEGIN_SRC emacs-lisp
(setq dired-auto-revert-buffer t)
(add-hook 'dired-mode-hook 'auto-revert-mode)
#+END_SRC
* Set Default Target to Use Open Buffer
#+BEGIN_SRC emacs-lisp
(setq dired-dwim-target t)
#+END_SRC
* Use A Single Buffer for Dired
#+BEGIN_SRC emacs-lisp
(use-package dired-single :ensure t)
(defun dired-single-init ()
  (set (make-local-variable 'mouse-1-click-follows-link) nil)
  (set (make-local-variable 'mouse-3-click-follows-link) nil)
  (define-key dired-mode-map [return] 'dired-single-buffer)
  (define-key dired-mode-map [mouse-1] 'dired-single-buffer-mouse)
  (define-key dired-mode-map [down-mouse-3] 'crux-open-with)
  (define-key dired-mode-map (kbd "<mouse-8>") (lambda nil (interactive) (dired-single-buffer "..")))
  (define-key dired-mode-map "^" (lambda nil (interactive) (dired-single-buffer ".."))))
(add-hook 'dired-mode-hook 'dired-single-init)
#+END_SRC
* Write Directory Changes Freestyle in wdired-mode
#+BEGIN_SRC emacs-lisp
(key-chord-define-global "wd" 'wdired-change-to-wdired-mode)
#+END_SRC
* Visit Home Directory
#+BEGIN_SRC emacs-lisp
(key-seq-define-global "1`" (lambda () (interactive) (dired "~/")))
#+END_SRC
